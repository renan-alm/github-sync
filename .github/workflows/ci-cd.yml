name: ðŸš€ CI/CD

on:
  pull_request:
    branches:
      - main
      - master
  push:
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      skip_release:
        description: 'Skip automatic release creation'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  actions: write
  checks: write

env:
  VERSION: 1.0.${{ github.run_number }}

jobs:
  test-bundle-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        id: checkout
        uses: actions/checkout@v5

      - name: Setup Node.js
        id: setup-node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install Dependencies
        id: npm-ci
        run: |
          npm install
          npm i -g @vercel/ncc

      - name: Bundle
        run: ncc build index.js --license licenses.txt

      - name: Check if new bundle is created and needs to be checked in
        id: gitChanges
        run: |
          git status
          if [[ -n "$(git status --porcelain ./dist)" ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Bundle changes detected"
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No bundle changes"
          fi

      - name: Commit changes
        if: steps.gitChanges.outputs.changes == 'true' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add ./dist
          git commit -m "ðŸ“¦ [skip ci]: Bundle and check javascript. Release $VERSION"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release
        if: steps.gitChanges.outputs.changes == 'true' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') && inputs.skip_release != true
        id: create_release
        run: |
          # Check if this is a major change that might warrant a manual release
          COMMIT_MSG=$(git log -1 --pretty=%B)
          if echo "$COMMIT_MSG" | grep -q -E "(BREAKING|breaking|major:|feat!:|fix!:)"; then
            echo "::notice::This appears to be a major change. Consider creating a manual release with proper semantic versioning."
          fi
          
          gh release create $VERSION ./dist/* \
            --title "Automated Release $VERSION" \
            --notes "ðŸ¤– This is an automated release created by the CI workflow.
          
          **Changes:**
          - Updated bundle from commit: \`${{ github.sha }}\`
          
          **Note:** For major releases, consider using the manual release workflow with proper semantic versioning."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create tags
        if: steps.gitChanges.outputs.changes == 'true' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') && inputs.skip_release != true
        run: |
          git tag $VERSION
          git push origin $VERSION
          # Only update v1 for automated releases, manual releases handle their own major tags
          git tag -fa v1 $VERSION -m "ðŸ“Œ Update v1 tag to $VERSION"
          git push origin v1 --force

      - name: Warn if no new binaries
        if: steps.gitChanges.outputs.changes != 'true'
        run: |
          echo "::notice::No new binaries have been created and no new release tag will be created."
          
      - name: Summary
        run: |
          echo "## ðŸ” CI/CD Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Bundle Changes:** ${{ steps.gitChanges.outputs.changes }}" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.gitChanges.outputs.changes }}" == "true" && ("${{ github.ref }}" == "refs/heads/main" || "${{ github.ref }}" == "refs/heads/master") ]]; then
            if [[ "${{ inputs.skip_release }}" == "true" ]]; then
              echo "**Release:** Skipped (manual override)" >> $GITHUB_STEP_SUMMARY
            else
              echo "**Release:** Created \`$VERSION\`" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ”— [View Release](https://github.com/${{ github.repository }}/releases/tag/$VERSION)" >> $GITHUB_STEP_SUMMARY
            fi
          fi
